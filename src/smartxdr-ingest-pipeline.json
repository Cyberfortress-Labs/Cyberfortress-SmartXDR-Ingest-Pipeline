{
    "description": "SmartXDR Log Classification Pipeline",
    "processors": [
        {
            "script": {
                "lang": "painless",
                "source": "String idx = ctx._index != null ? ctx._index.toLowerCase() : null;\nif (idx == null) return;\n\nboolean hit = (\n    idx.contains('wazuh') ||\n    idx.contains('zeek') ||\n    idx.contains('suricata') ||\n    idx.contains('pfsense') ||\n    idx.contains('modsecurity') ||\n    idx.contains('apache') ||\n    idx.contains('nginx') ||\n    idx.contains('mysql') ||\n    idx.contains('windows') ||\n    idx.contains('logs-system.security')\n);\n\nif (!hit) return;\n\nif (idx.contains('suricata')) {\n    String eventType = ctx.suricata?.eve?.event_type;\n    if (\n        eventType == null ||\n        eventType == 'stats' ||\n        eventType == 'flow' ||\n        eventType == 'netflow' ||\n        eventType == 'fileinfo' ||\n        eventType == 'dns'\n    ) {\n        return;\n    }\n    if (eventType == 'alert' && ctx.rule?.name != null) {\n        ctx.ml_input =\n            'Suricata: ' + ctx.rule.name +\n            ' | Category: ' + (ctx.rule?.category ?: 'Unknown') +\n            ' | ' + (ctx.source?.ip ?: '-') +\n            ' -> ' + (ctx.destination?.ip ?: '-');\n    }\n    return;\n}\n\nif (idx.contains('zeek')) {\n    String kind = ctx.event?.kind;\n    if (kind == null || kind != 'alert') return;\n    if (ctx.zeek?.notice == null) return;\n    if (ctx.rule?.name != null && ctx.rule?.description != null) {\n        ctx.ml_input =\n            'Zeek: ' + ctx.rule.name +\n            ' | Description: ' + ctx.rule.description +\n            ' | Peer: ' + (ctx.zeek.notice.peer_descr ?: '-');\n        return;\n    }\n    if (ctx.zeek.notice.msg != null) {\n        ctx.ml_input = 'Zeek Notice: ' + ctx.zeek.notice.msg;\n        return;\n    }\n    return;\n}\n\nif (idx.contains('pfsense')) {\n    String action = ctx.event?.action != null ? ctx.event.action.toLowerCase() : null;\n    if (action == null) return;\n    if (!(action == 'block' || action == 'reject')) return;\n    ctx.ml_input =\n        'pfSense: ' + action.toUpperCase() + ' ' +\n        (ctx.source?.ip ?: '-') + ':' + (ctx.source?.port ?: '-') +\n        ' -> ' +\n        (ctx.destination?.ip ?: '-') + ':' + (ctx.destination?.port ?: '-') +\n        ' | Proto: ' + (ctx.network?.transport ?: '-');\n    return;\n}\n\nif (idx.contains('wazuh') && ctx.rule?.description != null) {\n    String level = String.valueOf(ctx.rule?.level ?: '');\n    String agent = ctx.agent?.name ?: '-';\n    ctx.ml_input = 'Wazuh Alert [Level ' + level + ']: ' + ctx.rule.description + ' | Agent: ' + agent;\n    return;\n}\n\nif (ctx.rule?.description != null && ctx.full_log != null) {\n    ctx.ml_input = 'Alert: ' + ctx.rule.description + ' | Log: ' + ctx.full_log;\n    return;\n}\n\nif (idx.contains('apache')) {\n    String level = ctx.log?.level;\n    String msg = ctx.message;\n    boolean isAlert =\n        (level != null && (\n            level == 'error' ||\n            level == 'crit' ||\n            level == 'alert' ||\n            level == 'emerg' ||\n            level == 'warning'\n        )) ||\n        (msg != null && (\n            msg.toLowerCase().contains('error') ||\n            msg.toLowerCase().contains('failed') ||\n            msg.toLowerCase().contains('attack') ||\n            msg.toLowerCase().contains('denied') ||\n            msg.toLowerCase().contains('modsecurity')\n        ));\n    if (!isAlert) return;\n    ctx.ml_input =\n        'Apache: ' + (msg ?: '-') +\n        ' | Level: ' + (level ?: '-') +\n        ' | Host: ' + (ctx.host?.hostname ?: '-');\n    return;\n}\n\nif (idx.contains('mysql')) {\n    String msg = ctx.message;\n    String level = ctx.log?.level;\n    if (level == null || level != 'Warning') return;\n    ctx.ml_input = 'MySQL: ' + (ctx.message ?: '-');\n    return;\n}\n\nif (idx.contains('nginx')) {\n    String level = ctx.log?.level ?: '';\n    String msg = ctx.message ?: '';\n    if (level == 'notice') return;\n    if (\n        msg.contains('version') ||\n        msg.contains('loaded') ||\n        msg.contains('built') ||\n        msg.contains('using')\n    ) return;\n    ctx.ml_input = 'Nginx: ' + msg;\n    return;\n}\n\nif (ctx.observer?.type == 'firewall' && ctx.event?.action != null) {\n    ctx.ml_input =\n        'Firewall ' + ctx.event.action + ': ' +\n        (ctx.source?.ip ?: '-') + ':' + (ctx.source?.port ?: '-') +\n        ' -> ' +\n        (ctx.destination?.ip ?: '-') + ':' + (ctx.destination?.port ?: '-');\n    return;\n}\n\nif (idx.contains('logs-system.security')) {\n    String eventCode = ctx.event?.code != null ? ctx.event.code.toString() : null;\n    String action = ctx.event?.action;\n    String provider = ctx.winlog?.provider_name ?: ctx.event?.provider;\n    String msg = ctx.message;\n    String userName = ctx.user?.name ?: ctx.winlog?.event_data?.TargetUserName;\n    String domain = ctx.user?.domain ?: ctx.winlog?.event_data?.TargetDomainName;\n    String sourceIp = ctx.source?.ip;\n    String logonType = ctx.winlog?.event_data?.LogonType;\n    def keywordsList = ctx.winlog?.keywords;\n    String keywords = (keywordsList != null && keywordsList.size() > 0) ? keywordsList[0].toString() : null;\n    boolean isSecurityEvent = (\n        eventCode == '4624' ||\n        eventCode == '4625' ||\n        eventCode == '4627' ||\n        eventCode == '4634' ||\n        eventCode == '4672' ||\n        eventCode == '4648' ||\n        eventCode == '4688' ||\n        eventCode == '4720' ||\n        eventCode == '4722' ||\n        eventCode == '4723' ||\n        eventCode == '4724' ||\n        eventCode == '4725' ||\n        eventCode == '4726' ||\n        eventCode == '4740' ||\n        eventCode == '4768' ||\n        eventCode == '4769' ||\n        eventCode == '4776'\n    );\n    boolean isAuditFailure = (keywords != null && keywords.contains('Failure'));\n    if (!isSecurityEvent && !isAuditFailure) return;\n    String msgPart = '-';\n    if (msg != null) {\n        int len = msg.length();\n        msgPart = msg.substring(0, len > 500 ? 500 : len);\n    }\n    ctx.ml_input =\n        'Windows Security: EventCode=' + (eventCode ?: '-') +\n        ' | Action: ' + (action ?: '-') +\n        ' | Provider: ' + (provider ?: '-') +\n        ' | User: ' + (userName ?: '-') +\n        ' | Domain: ' + (domain ?: '-') +\n        (sourceIp != null ? ' | SourceIP: ' + sourceIp : '') +\n        (logonType != null ? ' | LogonType: ' + logonType : '') +\n        ' | Message: ' + msgPart;\n    return;\n}\n\nif (idx.contains('windows')) {\n    String level = ctx.log?.level;\n    String kind = ctx.event?.kind;\n    String action = ctx.event?.action;\n    String msg = ctx.message;\n    boolean isAlert =\n        (kind != null && kind == 'alert') ||\n        (level != null && (level == 'warning' || level == 'error' || level == 'critical')) ||\n        (msg != null && (\n            msg.contains('detect') ||\n            msg.contains('malware') ||\n            msg.contains('threat') ||\n            msg.contains('blocked') ||\n            msg.contains('quarantine') ||\n            msg.contains('virus')\n        )) ||\n        (action != null && (\n            action.contains('Detected') ||\n            action.contains('Blocked') ||\n            action.contains('Quarantined')\n        ));\n    if (!isAlert) return;\n    ctx.ml_input =\n        'Windows: ' +\n        (ctx.event?.code ?: '-') +\n        ' | Provider: ' + (ctx.event?.provider ?: '-') +\n        ' | Message: ' + (msg ?: '-');\n    return;\n}\n\nif (idx.contains('modsecurity')) {\n    if (ctx.modsec?.audit?.messages == null || ctx.modsec.audit.messages.size() == 0) return;\n    String query = ctx.url?.query;\n    if (query == null || query.trim().length() == 0) return;\n    String msgs = String.join('; ', ctx.modsec.audit.messages);\n    ctx.ml_input =\n        'ModSecurity: ' + msgs +\n        ' | URL: ' + (ctx.url?.original ?: '-') +\n        ' | Query: ' + query +\n        ' | SourceIP: ' + (ctx.source?.ip ?: '-');\n    return;\n}\n\nif (ctx.event?.original != null || ctx.message != null) {\n    ctx.ml_input = ctx.event?.original ?: ctx.message;\n}",
                "ignore_failure": true
            }
        },
        {
            "inference": {
                "model_id": "byviz__bylastic_classification_logs",
                "target_field": "ml.prediction",
                "field_map": {
                    "ml_input": "text_field"
                },
                "inference_config": {
                    "text_classification": {
                        "num_top_classes": 1
                    }
                },
                "if": "ctx.ml_input != null && ctx.ml_input instanceof String && ctx.ml_input.length() > 0 && ctx.ml_input.length() <= 5000",
                "on_failure": [
                    {
                        "append": {
                            "field": "tags",
                            "value": [
                                "_ml_inference_failure"
                            ],
                            "allow_duplicates": false
                        }
                    }
                ]
            }
        }
    ]
}